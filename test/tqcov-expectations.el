(require 'tqcov)

(defun tq-cov-test-setup (data-file)
  (setq dir (file-name-directory (buffer-file-name (current-buffer))))
  (tq-cov-create-stats-buffer (concat dir data-file)))

(expectations
   (desc "quoted list")
   (expect '(3 5)
     '(3 5))
   (expect '((3 5) (8 12))
     '((3 5) (8 12)))

   (desc "alist learning")
   (expect '("foo" . "bar")
     (setq words '(("hoge" . "fuga") ("foo" . "bar") ("toto" . "titi")))
     (assoc "foo" words)
     )
   (expect nil
     (setq words '(("hoge" . "fuga") ("foo" . "bar") ("toto" . "titi")))
     (assoc "BOO" words)
     )
   (expect '("hoge")
     (setq words '(("hoge")))
     (assoc "hoge" words)
     )
   (expect nil
     (setq words '(("hoge")))
     (cdr (assoc "hoge" words))
     )
   (expect '("fuga" "piyo" "moge")
     (setq words '(("hoge" "fuga" "piyo" "moge")))
     (cdr (assoc "hoge" words))
     )

   (desc "file contents loading")
   (expect 5
     (setq dir (file-name-directory (buffer-file-name (current-buffer))))
     (with-current-buffer (get-buffer-create "*tqcov-stats.csv*")
       (erase-buffer)
       (insert-file-contents (concat dir "coverage_stats.csv"))
       (count-lines (point-min) (point-max))))

   (desc "csv-forward-field")
   (expect 1
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (csv-forward-field 0)
       (point)
       ))
   (expect 21
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (csv-forward-field 1)
       (point)
       ))
   (expect 23
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (csv-forward-field 2)
       (point)
       ))
   (expect 25
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (csv-forward-field 3)
       (point)
       ))
   (expect 46
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (csv-forward-field 4)
       (point)
       ))

   (desc "tq-cov-current-csv-field-to-string")
   (expect "/path/to/app/init.js"
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (tq-cov-current-csv-field-to-string)))

   (desc "tq-cov-next-csv-field-to-string")
   (expect 1
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (string-to-number (tq-cov-next-csv-field-to-string))))
   (expect 2
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (tq-cov-next-csv-field-to-string)
       (string-to-number (tq-cov-next-csv-field-to-string))))

   (desc "tq-cov-current-csv-line-to-list")
   (expect '("/path/to/app/init.js" 1 2)
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (tq-cov-current-csv-line-to-list)))
   (expect '("/path/to/app/init.js" 3 1)
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (tq-cov-current-csv-line-to-list)
       (forward-line)
       (tq-cov-current-csv-line-to-list)))

   (desc "tq-cov-parse-buffer")
   (expect '("/path/to/app/init.js" 6 4)
     (with-current-buffer (tq-cov-test-setup "coverage_stats.csv")
       (assoc "/path/to/app/init.js" (tq-cov-parse-buffer (current-buffer)))
       ))
   (expect '("/path/to/app/init.js" 8 8 6 4)
     (with-current-buffer (tq-cov-test-setup "coverage_stats2.csv")
       (assoc "/path/to/app/init.js" (tq-cov-parse-buffer (current-buffer)))
       ))
   (expect '("/path/to/lib/utils.js" 82 82 76 76 70 70 62 62 55 55 38 37 29 27 24 22 17 17 6 4)
     (with-current-buffer (tq-cov-test-setup "coverage_stats3.csv")
       (assoc "/path/to/lib/utils.js" (tq-cov-parse-buffer (current-buffer)))
       ))
   (expect '("/path/to/app/init.js" 20 19)
     (with-current-buffer (tq-cov-test-setup "coverage_stats4.csv")
       (assoc "/path/to/app/init.js" (tq-cov-parse-buffer (current-buffer)))
       ))
   (expect '("/path/to/lib/utils.js" 82 82 76 76 70 70 62 62 55 55 38 37 29 27 24 22 17 17 6 4)
     (with-current-buffer (tq-cov-test-setup "coverage_stats4.csv")
       (assoc "/path/to/lib/utils.js" (tq-cov-parse-buffer (current-buffer)))
       ))

   (desc "tq-cov-create-tuple-pairs")
   (expect '(("foo" "bar") ("baz" "hoge"))
     (tq-cov-create-tuple-pairs '("foo" "bar" "baz" "hoge")))
   (expect '(("foo" "bar") ("baz" "hoge") ("fuga" nil))
     (tq-cov-create-tuple-pairs '("foo" "bar" "baz" "hoge" "fuga")))

   (desc "tq-cov-reverse-cdr-of-alist")
   (expect '("Japanese" . ("piyo" "fuga" "hoge"))
     (setq words '(("Japanese" . ("hoge" "fuga" "piyo")) ("English" . ("foo" "bar" "baz"))))
     (assoc "Japanese" (tq-cov-reverse-cdr-of-alist words))
     )
   (expect '("English" . ("baz" "bar" "foo"))
     (setq words '(("Japanese" . ("hoge" "fuga" "piyo")) ("English" . ("foo" "bar" "baz"))))
     (assoc "English" (tq-cov-reverse-cdr-of-alist words))
     )
   (expect '("/path/to/app/init.js" 4 6 8 8)
     (with-current-buffer (tq-cov-test-setup "coverage_stats2.csv")
       (setq rev-alist (tq-cov-reverse-cdr-of-alist (tq-cov-parse-buffer (current-buffer))))
       (assoc "/path/to/app/init.js" rev-alist)
       ))

   (desc "tq-cov-tuplize-cdr-of-alist")
   (expect '("Japanese" . (("hoge" "fuga") ("piyo" "moge")))
     (setq words '(("Japanese" . ("hoge" "fuga" "piyo" "moge")) ("English" . ("foo" "bar" "baz" "moo"))))
     (assoc "Japanese" (tq-cov-tuplize-cdr-of-alist words))
     )
   (expect '("English" . (("foo" "bar") ("baz" "moo")))
     (setq words '(("Japanese" . ("hoge" "fuga" "piyo" "moge")) ("English" . ("foo" "bar" "baz" "moo"))))
     (assoc "English" (tq-cov-tuplize-cdr-of-alist words))
     )

   (desc "tq-cov-create-stats-alist-from-buffer")
   (expect '((4 6) (17 17) (22 24) (27 29) (37 38) (55 55) (62 62) (70 70) (76 76) (82 82))
     (setq stats-buf (tq-cov-test-setup "coverage_stats4.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/lib/utils.js" stats-alist)))
   (expect '((19 20))
     (setq stats-buf (tq-cov-test-setup "coverage_stats4.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/app/init.js" stats-alist)))

   (desc "tq-cov-create-stats-alist-from-buffer bug reproduction")
   (expect '((4 6) (17 17) (22 24) (27 29) (37 38) (55 55) (62 62) (70 70) (76 76) (82 82))
     (setq stats-buf (tq-cov-test-setup "coverage_stats4_reverse.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/lib/utils.js" stats-alist)))
   (expect '((19 20))
     (setq stats-buf (tq-cov-test-setup "coverage_stats4_reverse.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/app/init.js" stats-alist)))

   (desc "large data")
   (expect '((2 2) (80 80) (95 95) (203 204) (210 211) (217 222) (224 224) (226 226) (235 238) (245 245) (250 255) (290 290)  (300 303) (305 310) (360 360))
     (setq stats-buf (tq-cov-test-setup "coverage_stats5.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/app/util.js" stats-alist)))
   (expect '((5 5) (30 34) (37 39) (45 46) (48 51) (54 54) (59 62) (67 75) (82 92) (98 100) (102 102) (107 107) (111 113) (115 115) (120 122) (124 124) (126 126) (130 132) (134 134) (136 136) (140 142) (144 144) (146 146) (159 160) (168 168) (172 176) (178 179) (181 182) (184 185) (207 207) (217 223) (225 225) (229 229) (231 234) (245 246) (249 249) (251 251) (255 259) (261 263) (265 265) (267 267) (270 271) (273 274) (279 281) (283 285) (290 291) (293 295) (299 301) (305 306) (309 310) (313 313) (316 316) (342 346) (350 350) (352 354) (358 363) (367 368) (372 375) (377 378) (388 390) (392 393) (395 395) (400 400) (404 404) (409 409) (413 417) (419 419) (424 424) (428 428) (432 432) (436 436) (445 445) (450 451) (453 453) (456 462) (464 464) (470 471) (476 476) (478 480) (482 487) (489 489) (491 491) (494 494) (497 498) (502 504) (506 506) (510 512) (517 520) (522 522) (531 531) (536 537) (545 546) (548 551) (553 553) (556 561) (563 564) (566 570) (572 573) (578 579) (584 586) (588 588) (590 590) (594 596) (600 604) (606 607) (609 613) (616 617) (619 619) (621 625) (627 627) (631 633) (636 636) (640 642) (655 655) (658 658) (663 663) (666 666) (700 703) (706 706) (709 709) (712 712) (715 715) (731 732) (735 736) (752 755) (757 757) (762 762) (766 766) (770 771) (781 781) (785 785) (789 792) (802 803) (807 807) (811 815) (819 822) (833 834) (850 851) (855 855) (859 859) (863 869) (873 876) (878 880) (892 892) (894 897) (901 901) (904 904) (912 917) (919 919) (924 930) (940 942) (944 944) (947 948) (950 951) (953 954) (956 957) (959 960) (962 962) (965 965) (967 967) (969 971) (975 975) (984 986) (988 988) (991 995) (997 1003) (1005 1005))
     (setq stats-buf (tq-cov-test-setup "coverage_stats5.csv"))
     (setq stats-alist (tq-cov-create-stats-alist-from-buffer stats-buf))
     (cdr (assoc "/path/to/app/adapters/prototype_js/composite_dialog.js" stats-alist)))

   )
